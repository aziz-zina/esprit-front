<!-- Outer Fuse structure (Assume this exists above) -->
<!-- <div class="flex min-w-0 flex-auto flex-col"> -->
<!--    <div class="flex-auto p-6 sm:p-10"> -->

        <!-- CONTENT GOES HERE -->
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">

            <!-- Left Column: Repo Management, Git Controls & File Tree -->
            <div class="space-y-6 lg:col-span-1">

                <!-- Repository Management Section -->
                <div class="rounded-lg border border-gray-300 bg-gray-50 p-4 shadow-sm">
                    <h2 class="mb-4 text-xl font-semibold text-gray-800">Repository Management</h2>

                    <!-- Fetch Repos Button -->
                    <div class="mb-4">
                        <button type="button" (click)="fetchGithubRepos()" [disabled]="isFetchingRepos || !githubAccessToken" class="btn-primary w-full disabled:opacity-50">
                            {{ isFetchingRepos ? 'Fetching...' : (githubAccessToken ? 'Fetch My GitHub Repos' : 'Get Token First') }}
                        </button>
                         <button *ngIf="!githubAccessToken" type="button" (click)="fetchGithubAccessToken()" [disabled]="isLoading" class="btn-secondary w-full mt-2 disabled:opacity-50">
                             {{ isLoading ? 'Getting Token...' : 'Retry Get GitHub Token' }}
                         </button>
                    </div>

                    <!-- Available GitHub Repos -->
                    <div *ngIf="githubRepoList" class="mb-4 border-t pt-4">
                        <h3 class="mb-2 text-base font-semibold text-gray-700">Available on GitHub</h3>
                        <div *ngIf="isFetchingRepos" class="text-sm text-gray-500">Loading...</div>
                        <div *ngIf="!isFetchingRepos && githubRepoList.length === 0" class="text-sm text-gray-500">No repositories found or error fetching.</div>
                        <ul *ngIf="!isFetchingRepos && githubRepoList.length > 0" class="max-h-48 overflow-y-auto space-y-1 text-sm">
                            <li *ngFor="let repo of githubRepoList" class="flex items-center justify-between p-1 rounded hover:bg-gray-100">
                                <span class="truncate" [title]="repo.full_name">{{ repo.full_name }} <span *ngIf="repo.private" class="text-xs text-gray-500">(Private)</span></span>
                                <button type="button" (click)="addRepoToManaged(repo)" [disabled]="isRepoManaged(repo.id)" class="btn-secondary btn-xs disabled:opacity-50 disabled:cursor-not-allowed">
                                    {{ isRepoManaged(repo.id) ? 'Managed' : 'Manage Locally' }}
                                </button>
                            </li>
                        </ul>
                    </div>

                    <!-- Managed Repositories -->
                    <div class="border-t pt-4">
                         <h3 class="mb-2 text-base font-semibold text-gray-700">Managed Locally</h3>
                         <div *ngIf="managedRepositories.length === 0" class="text-sm text-gray-500">Add repositories from the list above to manage them here.</div>
                         <ul *ngIf="managedRepositories.length > 0" class="max-h-48 overflow-y-auto space-y-1 text-sm">
                            <li *ngFor="let managedRepo of managedRepositories"
                                class="flex items-center justify-between p-1 rounded cursor-pointer"
                                [class.bg-indigo-100]="activeRepository?.id === managedRepo.id"
                                [class.hover:bg-gray-100]="activeRepository?.id !== managedRepo.id"
                                (click)="setActiveRepository(managedRepo)"
                                [title]="'Activate ' + managedRepo.fullName">
                                <span class="truncate font-medium" [class.text-indigo-700]="activeRepository?.id === managedRepo.id">
                                    {{ managedRepo.fullName }}
                                </span>
                                <button type="button" (click)="$event.stopPropagation(); removeManagedRepo(managedRepo)" [disabled]="isLoading" class="btn-secondary btn-xs text-red-600 hover:bg-red-50 disabled:opacity-50">
                                    Remove
                                </button>
                            </li>
                         </ul>
                    </div>
                </div> <!-- End Repo Management Section -->


                <!-- Git Controls Section (Operates on Active Repo) -->
                <div class="rounded-lg border border-gray-300 bg-gray-50 p-4 shadow-sm">
                    <h2 class="mb-2 text-xl font-semibold text-gray-800">
                        Git Controls <span *ngIf="activeRepository" class="text-base font-normal text-indigo-600">- {{ activeRepository.name }}</span>
                    </h2>
                    <div *ngIf="!activeRepository" class="text-sm text-gray-500 mb-4">Select a managed repository to enable controls.</div>

                    <!-- Action Buttons -->
                    <div class="mb-4 flex flex-wrap gap-3" *ngIf="activeRepository">
                        <button type="button" (click)="cloneRepo()" [disabled]="isLoading || !activeRepository || !githubAccessToken" class="btn-primary disabled:opacity-50">
                            {{ cloneDone ? 'Re-Clone' : 'Clone' }}
                        </button>
                        <button type="button" (click)="pullChanges()" [disabled]="isLoading || !cloneDone || !githubAccessToken" class="btn-secondary disabled:opacity-50">
                            Pull
                        </button>
                        <button type="button" (click)="pushChanges()" [disabled]="isLoading || !cloneDone || !githubAccessToken" class="btn-secondary disabled:opacity-50" title="Push requires token & permissions">
                            Push
                        </button>
                        <button type="button" (click)="getStatus()" [disabled]="isLoading || !cloneDone" class="btn-secondary disabled:opacity-50">
                            Status
                        </button>
                    </div>
                    <!-- Loading Indicator -->
                    <div *ngIf="isLoading" class="loading-indicator">Processing Git operation...</div>
                </div> <!-- End Git Controls Section -->

                <!-- File Tree Display Section (Operates on Active Repo) -->
                <div class="rounded-lg border border-gray-300 bg-white p-4 shadow-sm">
                    <div class="mb-3 flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-700">
                            Repository Files <span *ngIf="activeRepository" class="text-base font-normal text-indigo-600">- {{ activeRepository.name }} (HEAD)</span>
                        </h3>
                        <button type="button" (click)="buildAndDisplayFileTree()" [disabled]="isLoading || isProcessingTree || !cloneDone" class="btn-secondary btn-xs disabled:opacity-50">
                            {{ isProcessingTree ? 'Loading...' : 'Refresh Tree' }}
                        </button>
                    </div>

                    <div *ngIf="!activeRepository" class="text-sm text-gray-500">Select a managed repository.</div>
                    <div *ngIf="activeRepository && !cloneDone && !isLoading" class="text-sm text-gray-500">Clone the repository to see files.</div>
                    <div *ngIf="activeRepository && cloneDone && isProcessingTree && repositoryTree.length === 0" class="text-sm text-gray-500">Loading file tree...</div>
                    <div *ngIf="activeRepository && cloneDone && !isProcessingTree && repositoryTree.length === 0" class="text-sm text-gray-500">
                        No files found in HEAD or repository seems empty.
                    </div>

                    <!-- Recursive Tree Structure -->
                    <div *ngIf="activeRepository && cloneDone && repositoryTree.length > 0" class="max-h-96 overflow-y-auto text-sm">
                        <ng-container *ngTemplateOutlet="treeNodeTemplate; context: { nodes: repositoryTree, level: 0 }"></ng-container>
                    </div>
                </div> <!-- End File Tree Section -->

            </div> <!-- End Left Column -->

            <!-- Right Column: File Content Editor & Output Log -->
            <div class="space-y-6 lg:col-span-2">

                <!-- File Content Editor -->
                <div class="rounded-lg border border-gray-300 bg-white p-4 shadow-sm min-h-[300px] flex flex-col">
                    <div class="flex items-center justify-between mb-3">
                         <h3 class="text-lg font-semibold text-gray-700">File Content</h3>
                          <!-- Editor Action Buttons -->
                         <div class="flex items-center gap-2" *ngIf="selectedFile && !selectedFile.isLoading && !selectedFile.error">
                              <button type="button" (click)="saveFileChanges()" [disabled]="!selectedFile?.isDirty || isSavingFile || isLoading" class="btn-primary btn-xs disabled:opacity-50">
                                  {{ isSavingFile ? 'Saving...' : 'Save Changes' }}
                              </button>
                              <button type="button" (click)="commitChanges()" [disabled]="selectedFile?.isDirty || isSavingFile || isLoading" class="btn-secondary btn-xs disabled:opacity-50" title="Save changes first to enable commit">
                                  Commit...
                              </button>
                         </div>
                    </div>

                    <div *ngIf="!activeRepository" class="text-sm text-gray-500">Select a managed repository first.</div>
                    <div *ngIf="activeRepository && !selectedFile" class="text-sm text-gray-500">Select a file from the tree to view/edit its content.</div>

                    <div *ngIf="selectedFile" class="flex-grow flex flex-col">
                        <div class="mb-2 font-mono text-sm font-semibold text-indigo-700 flex justify-between items-center">
                           <span> {{ selectedFile.path }} </span>
                           <span *ngIf="selectedFile.isDirty" class="text-xs font-normal text-orange-600">(modified)</span>
                        </div>
                        <div *ngIf="selectedFile.isLoading" class="loading-indicator">Loading content...</div>
                        <div *ngIf="selectedFile.error" class="text-red-600 text-sm p-2 border border-red-300 bg-red-50 rounded">
                           Error: {{ selectedFile.error }}
                        </div>

                        <!-- *** Codemirror Editor Integration *** -->
                        <div *ngIf="selectedFile.content !== null && !selectedFile.isLoading && !selectedFile.error" class="flex-grow border rounded overflow-hidden h-96">
                             <ngx-codemirror
                                 *ngIf="selectedFile.content !== null"
                                 [(ngModel)]="selectedFile.content"
                                 [options]="cmOptions"
                                 (ngModelChange)="onCodeMirrorChange($event)">
                             </ngx-codemirror>
                        </div>
                         <!-- Fallback for null content just in case -->
                         <div *ngIf="selectedFile.content === null && !selectedFile.isLoading && !selectedFile.error" class="text-sm text-gray-500">
                             File content is empty or could not be loaded as text.
                         </div>
                    </div>
                </div> <!-- End File Content Editor -->


                <!-- Output Log Section -->
                <div class="rounded-lg border border-gray-300 bg-gray-100 p-4 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-gray-700">Output Log</h3>
                        <button type="button" (click)="clearOutput()" [disabled]="isLoading || isProcessingTree || isSavingFile" class="btn-secondary btn-xs disabled:opacity-50">
                            Clear Log
                        </button>
                    </div>
                    <pre class="h-60 max-h-80 min-h-40 overflow-y-auto rounded bg-white p-3 text-xs font-mono leading-relaxed shadow-inner">{{ output.length > 0 ? output.join('\n') : 'No output yet.' }}</pre>
                </div> <!-- End Output Log Section -->

            </div> <!-- End Right Column -->

        </div> <!-- End Grid -->
<!--    </div> --> <!-- End Main Content Area -->
<!-- </div> --> <!-- End Outer Fuse structure -->


<!-- ======================= -->
<!-- Recursive Tree Template -->
<!-- ======================= -->
<ng-template #treeNodeTemplate let-nodes="nodes" let-level="level">
    <ul class="list-none p-0 m-0">
        <li *ngFor="let node of nodes" class="my-1">
            <div class="flex items-center cursor-pointer hover:bg-gray-100 rounded p-1"
                 [style.padding-left.rem]="level * 1.2"
                 (click)="node.isDirectory ? toggleNodeExpansion(node) : viewFileContent(node)"
                 [class.bg-indigo-100]="selectedFile?.path === node.path && !node.isDirectory"
                 [title]="node.path">

                <!-- Folder/File Icon & Expander -->
                <ng-container *ngIf="node.isDirectory">
                     <!-- (Folder icon as before) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-blue-600 flex-shrink-0 transition-transform duration-150" [class.rotate-90]="node.expanded" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /> </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-yellow-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /> </svg>
                </ng-container>
                <ng-container *ngIf="!node.isDirectory">
                     <!-- (File icon as before) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500 flex-shrink-0 ml-[1rem]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /> </svg>
                </ng-container>

                <!-- Name -->
                <span class="truncate">{{ node.name }}</span>
            </div>

            <!-- Recursive Call for Children -->
            <div *ngIf="node.isDirectory && node.expanded && node.children && node.children.length > 0">
                <ng-container *ngTemplateOutlet="treeNodeTemplate; context: { nodes: node.children, level: level + 1 }"></ng-container>
            </div>
        </li>
    </ul>
</ng-template>

<!-- Helper CSS (Minimal, use Tailwind where possible) -->
<style>
    /* Add styles for Codemirror height if needed, or use Tailwind H classes on wrapper */
    .CodeMirror {
       height: 100% !important; /* Make editor fill its container */
       font-family: monospace; /* Ensure monospace font */
    }
    .btn-primary { @apply inline-flex items-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2; }
    .btn-secondary { @apply inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2; }
    .btn-xs { @apply px-2.5 py-1.5 text-xs; }
    .loading-indicator { @apply my-3 flex items-center text-sm text-blue-600; }
    /* Add SVG spinner styles if needed, or use Tailwind spin */
    .loading-indicator svg { @apply animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500; }
</style>